<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background-color: #1c1c1c; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; width: 100vw; flex-direction: column; }
        .cart-container { text-align: center; width: 90%; max-width: 600px; background: #2c2c2c; padding: 20px; border-radius: 10px; box-shadow: 0px 4px 10px rgba(0,0,0,0.3); }
        h2 { margin-bottom: 20px; }
        .cart-list { display: flex; flex-direction: column; gap: 10px; }
        .cart-item { display: flex; align-items: center; justify-content: space-between; background: #f0ddca; color: black; padding: 10px; border-radius: 5px; }
        .cart-item img { width: 50px; height: 50px; border-radius: 5px; object-fit: cover; }
        .quantity-controls { display: flex; align-items: center; gap: 5px; }
        .quantity-btn { cursor: pointer; padding: 5px 10px; border: none; background: #444; color: white; border-radius: 3px; }
        .buttons-container { display: flex; justify-content: space-between; gap: 10px; margin-top: 20px; }
        .back-btn, .order-btn { flex: 1; padding: 10px; border: none; border-radius: 5px; cursor: pointer; }
        .back-btn { background: #555; color: white; }
        .order-btn { background: #8b5a2b; color: white; }
        .time-selector { margin-top: 15px; }
        select { padding: 8px; border-radius: 5px; border: none; font-size: 16px; background: #444; color: white; }
    </style>
</head>
<body>
    <div class="cart-container">
        <h2>Carrito de Compras</h2>
        <div class="cart-list" id="cart-list"></div>

        <div class="time-selector">
            <label for="pickup-time">Selecciona la hora de retiro:</label>
            <select id="pickup-time">
                <option value="">Elige un horario</option>
            </select>
        </div>

        <div class="buttons-container">
            <button class="back-btn" onclick="window.history.back()">Volver Atrás</button>
            <button class="order-btn" onclick="placeOrder()">Realizar Pedido</button>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const response = await fetch("https://menta-backend.vercel.app/food");
            const menuData = await response.json();
            const cartList = document.getElementById("cart-list");
            const pickupTimeSelect = document.getElementById("pickup-time");

            function getProductById(id) {
                for (const category of menuData.data) {
                    const product = category.food.find(item => item.id == id);
                    if (product) return product;
                }
                return null;
            }

            function updateCart(productId, change) {
                productId = Number(productId);
                
                let cart = JSON.parse(sessionStorage.getItem("cart")) || [];

                let productIndex = cart.findIndex(item => item.id === productId);

                if (productIndex !== -1) {
                    cart[productIndex].quantity += change;
                    if (cart[productIndex].quantity <= 0) {
                        cart.splice(productIndex, 1);
                    }
                } else if (change > 0) {
                    cart.push({ id: productId, quantity: change });
                }

                sessionStorage.setItem("cart", JSON.stringify(cart));
                renderCart();
            }

            window.updateCart = updateCart;

            function renderCart() {
                cartList.innerHTML = "";
                const cart = JSON.parse(sessionStorage.getItem("cart")) || [];

                cart.forEach(item => {
                    const product = getProductById(item.id);
                    if (!product) return;

                    const cartItem = document.createElement("div");
                    cartItem.classList.add("cart-item");
                    cartItem.innerHTML = `
                        <img src="${product.image}" alt="${product.name}">
                        <span>${product.name} - $${product.price}</span>
                        <div class="quantity-controls">
                            <button class="quantity-btn" onclick="updateCart(${item.id}, -1)">-</button>
                            <span>${item.quantity}</span>
                            <button class="quantity-btn" onclick="updateCart(${item.id}, 1)">+</button>
                        </div>
                    `;
                    cartList.appendChild(cartItem);
                });
            }

            function generatePickupTimes() {
                const startHour = 8;
                const endHour = 21;
                const interval = 30;
                for (let hour = startHour; hour < endHour; hour++) {
                    for (let minute = 0; minute < 60; minute += interval) {
                        const formattedTime = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                        const option = document.createElement("option");
                        option.value = formattedTime;
                        option.textContent = formattedTime;
                        pickupTimeSelect.appendChild(option);
                    }
                }
            }

            window.placeOrder = async function() {
                const selectedTime = pickupTimeSelect.value;
                const cart = JSON.parse(sessionStorage.getItem("cart")) || [];

                if (cart.length === 0) {
                    alert("El carrito está vacío. Agrega productos antes de hacer un pedido.");
                    return;
                }
                if (!selectedTime) {
                    alert("Por favor, selecciona un horario de retiro.");
                    return;
                }

                const now = new Date();
                const pickupDateTime = new Date(now.toDateString() + ' ' + selectedTime);

               await fetch("https://menta-backend.vercel.app/order", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        order: cart,
                        hour: pickupDateTime.toISOString(),
                        userId: sessionStorage.getItem("userId")
                    })
                }).then(response => {
                    if (response.status === 200) {
                        alert("Pedido realizado con éxito");
                        sessionStorage.removeItem("cart");
                        renderCart();
                    } else {
                        response.json().then(data => {
                            console.log(JSON.stringify({
                        order: cart,
                        hour: pickupDateTime.toISOString(),
                        userId: sessionStorage.getItem("userId")
                    }))
                            console.log(data);
                            alert("Hubo un error al realizar el pedido");
                        });
                    }
                });
            };

            generatePickupTimes();
            renderCart();
        });
    </script>
</body>
</html>
